///$tab Main
SET ThousandSep=',';
SET DecimalSep='.';
SET MoneyThousandSep=',';
SET MoneyDecimalSep='.';
SET MoneyFormat='$ ###0.00;-$ ###0.00';
SET TimeFormat='h:mm:ss TT';
SET DateFormat='M/D/YYYY';
SET TimestampFormat='M/D/YYYY h:mm:ss[.fff] TT';
SET FirstWeekDay=6;
SET BrokenWeeks=1;
LOAD
    "Booking ID",
    "Event ID",
    "Space ID",
    "Date of Booking",
    "Start Time",
    "End Time",
    "Number of Pax",
    "Booking Revenue",
    "Order Type",
    "Sale Channel",
    "Target Revenue",
    F12,
    F13,
    F14,
    F15,
    F16,
    F17,
    F18,
    F19,
    F20,
    F21,
    F22,
    F23,
    F24,
    F25,
    F26
FROM [lib://Test-160725:DataFiles/Mock Data (ML) - Copy.xlsx]
(ooxml, embedded labels, table is EventBooking);


SET ReferenceDay=0;
SET FirstMonthOfYear=1;
SET CollationLocale='en-US';
SET CreateSearchIndexOnReload=1;
SET MonthNames='Jan;Feb;Mar;Apr;May;Jun;Jul;Aug;Sep;Oct;Nov;Dec';
SET LongMonthNames='January;February;March;April;May;June;July;August;September;October;November;December';
SET DayNames='Mon;Tue;Wed;Thu;Fri;Sat;Sun';
SET LongDayNames='Monday;Tuesday;Wednesday;Thursday;Friday;Saturday;Sunday';
SET NumericalAbbreviation='3:k;6:M;9:G;12:T;15:P;18:E;21:Z;24:Y;-3:m;-6:Î¼;-9:n;-12:p;-15:f;-18:a;-21:z;-24:y';


LOAD * INLINE [
  DummyField
  TEST
];

LIB CONNECT TO 'Dev_Space:Azure_SQL_Database_cvc-dev';

///$tab Auto-generated section
///$autogenerated
Set dataManagerTables = '','space_master_data (1)';
//This block renames script tables from non generated section which conflict with the names of managed tables

For each name in $(dataManagerTables) 
    Let index = 0;
    Let currentName = name; 
    Let tableNumber = TableNumber(name); 
    Let matches = 0; 
    Do while not IsNull(tableNumber) or (index > 0 and matches > 0)
        index = index + 1; 
        currentName = name & '-' & index; 
        tableNumber = TableNumber(currentName) 
        matches = Match('$(currentName)', $(dataManagerTables));
    Loop 
    If index > 0 then 
            Rename Table '$(name)' to '$(currentName)'; 
    EndIf; 
Next; 
Set dataManagerTables = ;


Unqualify *;

__countryAliasesBase:
LOAD
	Alias AS [__Country],
	ISO3Code AS [__ISO3Code]
FROM [lib://Test-160725:DataFiles/countryAliases.qvd]
(qvd);

__countryGeoBase:
LOAD
	ISO3Code AS [__ISO3Code],
	ISO2Code AS [__ISO2Code],
	Polygon AS [__Polygon]
FROM [lib://Test-160725:DataFiles/countryGeo.qvd]
(qvd);

__cityAliasesBase:
LOAD
	Alias AS [__City],
	geoKey AS [__geoKey],
	CountryCode AS [__CityCountryCode]
FROM [lib://Test-160725:DataFiles/cityAliases.qvd]
(qvd);

__cityGeoBase:
LOAD
	geoKey AS [__geoKey],
	geoPoint AS [__GeoPoint]
FROM [lib://Test-160725:DataFiles/cityGeo.qvd]
(qvd);

__countryName2IsoThree:
MAPPING LOAD
	__Country,
	__ISO3Code
RESIDENT __countryAliasesBase;

__countryCodeIsoThree2Polygon:
MAPPING LOAD
	__ISO3Code,
	__Polygon
RESIDENT __countryGeoBase;

__countryCodeAndCityName2Key:
MAPPING LOAD
	__CityCountryCode & __City,
	__geoKey
RESIDENT __cityAliasesBase;

__cityKey2GeoPoint:
MAPPING LOAD
	__geoKey,
	__GeoPoint
RESIDENT __cityGeoBase;

[space_master_data (1)]:
LOAD
	[@1],
	[@2],
	[@3],
	[@4],
	[@5],
	[@6],
	[@7],
	[@8],
	[@9],
	APPLYMAP( '__countryCodeIsoThree2Polygon', APPLYMAP( '__countryName2IsoThree', LOWER([@7])), '-') AS [space_master_data (1).@7_GeoInfo],
	APPLYMAP( '__cityKey2GeoPoint', APPLYMAP( '__countryCodeAndCityName2Key', APPLYMAP( '__countryName2IsoThree', LOWER([@7])) & LOWER([@8])), '-') AS [space_master_data (1).@8_GeoInfo]
 FROM [lib://Test-160725:DataFiles/space_master_data (1).csv]
(txt, codepage is 28591, no labels, delimiter is ',', msq);



TAG FIELD [@7] WITH '$geoname', '$relates_space_master_data (1).@7_GeoInfo';
TAG FIELD [space_master_data (1).@7_GeoInfo] WITH '$geopolygon', '$hidden', '$relates_@7';
TAG FIELD [@8] WITH '$geoname', '$relates_space_master_data (1).@8_GeoInfo';
TAG FIELD [space_master_data (1).@8_GeoInfo] WITH '$geopoint', '$hidden', '$relates_@8';

DROP TABLES __countryAliasesBase, __countryGeoBase, __cityAliasesBase, __cityGeoBase;
